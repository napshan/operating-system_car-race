OS Racer 遊戲開發變更日誌
===========================

本文件記錄從原始版本到當前版本的所有功能添加和代碼修改。

================================================================================
版本歷史
================================================================================

【當前版本】v2.0 - 完整音效系統版本
【原始版本】v1.0 - 基礎多線程賽車遊戲

================================================================================
主要功能添加
================================================================================

1. 音效系統 (Audio System)
   ────────────────────────────────────────────────────────────────────────
   【新增】完整的音效播放系統
   - 使用 Windows MCI (Media Control Interface) API 播放音頻文件
   - 支持 MP3 和 WAV 格式
   - 智能格式檢測和自動降級機制
   
   【新增】音效文件管理
   - 音效文件統一放在 audio/ 資料夾
   - 添加 GetAudioPath() 函數自動組合路徑
   - 改進的資源管理和錯誤處理
   
   【新增】多音效疊加播放
   - 引擎運轉聲和加速聲可以同時播放
   - 使用不同的 MCI alias 實現疊加效果
   - 支持多個音效同時播放而不衝突

2. 引擎音效系統 (Engine Sound System)
   ────────────────────────────────────────────────────────────────────────
   【新增】引擎運轉聲 (engine_idle)
   - 車子移動時持續播放
   - 自動循環播放
   - 車速為 0 時自動停止
   
   【新增】引擎加速聲 (engine_accel)
   - 按加速鍵時播放
   - 與運轉聲疊加播放
   - 鬆開加速鍵時立即停止
   - 按下加速鍵時重新開始播放（重置效果）
   
   【新增】RPM 動態計算
   - 根據車速動態計算引擎 RPM (800-4000 RPM)
   - 加速時增加額外 RPM
   - 平滑的 RPM 過渡效果

3. 背景音樂系統 (Background Music System)
   ────────────────────────────────────────────────────────────────────────
   【新增】背景音樂播放
   - 進入地圖後自動開始播放
   - 自動循環播放
   - 遊戲結束或勝利時自動停止
   - 播放狀態監控和自動恢復機制

4. 互動音效系統 (Interactive Sound Effects)
   ────────────────────────────────────────────────────────────────────────
   【新增】煞車音效 (brake)
   - 按左右鍵轉向時播放
   - 鬆開按鍵時立即停止
   - 只在移動時播放
   
   【新增】碰撞音效 (crash)
   - 撞到障礙物或邊界時播放
   - 播放一次
   
   【新增】遊戲結束音效 (gameover)
   - 遊戲結束時播放
   - 會停止背景音樂
   
   【新增】勝利音效 (victory)
   - 完成賽道時播放
   - 會停止背景音樂和所有引擎聲
   - 支持 MP3 和 WAV 格式自動切換

5. 視覺效果增強 (Visual Effects Enhancement)
   ────────────────────────────────────────────────────────────────────────
   【新增】速度感視覺效果
   - 動態道路線條
   - 背景模糊效果（根據速度調整）
   - 速度條顯示
   - ">>> HIGH SPEED <<<" 指示器
   
   【新增】結束畫面
   - GAME OVER 畫面：顯示最終距離、時間、速度
   - VICTORY 畫面：顯示完成時間、平均速度、性能評級
   - 動畫效果和顏色變化
   - ASCII 藝術標題

6. 用戶界面改進 (UI Improvements)
   ────────────────────────────────────────────────────────────────────────
   【新增】全螢幕布局修復
   - 鎖定控制台窗口大小 (120x30)
   - 禁用窗口調整大小
   - 修復全螢幕時的布局問題
   
   【改進】HUD 顯示
   - 速度條顯示
   - 更清晰的狀態指示
   - 改進的距離顯示

================================================================================
代碼結構變更
================================================================================

1. 新增常量和變量
   ────────────────────────────────────────────────────────────────────────
   【新增】音效文件路徑常量
   - AUDIO_FOLDER: 音效資料夾路徑
   - ENGINE_IDLE_FILE: 引擎運轉聲文件
   - ENGINE_ACCEL_FILE: 引擎加速聲文件
   - BRAKE_SOUND_FILE: 煞車聲文件
   - CRASH_SOUND_FILE: 碰撞聲文件
   - GAMEOVER_SOUND_FILE: 遊戲結束聲文件
   - WIN_SOUND_FILE: 勝利聲文件
   - BGM_FILE: 背景音樂文件
   
   【新增】音效狀態原子變量
   - bgm_playing: 背景音樂播放狀態
   - engine_idle_playing: 引擎運轉聲播放狀態
   - engine_accel_playing: 引擎加速聲播放狀態
   - brake_sound_playing: 煞車聲播放狀態
   - sound_crash: 碰撞音效觸發標誌
   - sound_gameover: 遊戲結束音效觸發標誌
   - sound_win: 勝利音效觸發標誌
   - sound_brake: 煞車音效觸發標誌
   - engineRPM: 引擎 RPM 值

2. 新增函數
   ────────────────────────────────────────────────────────────────────────
   【新增】GetAudioPath()
   - 功能：組合音效文件的完整路徑
   - 參數：文件名
   - 返回：完整路徑字符串
   
   【新增】PlayAudioFile()
   - 功能：播放音頻文件（使用默認 alias）
   - 參數：文件名、是否循環
   - 特性：智能格式檢測、自動降級、資源管理
   
   【新增】PlayAudioFileWithAlias()
   - 功能：使用自定義 alias 播放音頻文件
   - 參數：文件名、alias、是否循環
   - 特性：支持多音效疊加、資源檢查、錯誤處理
   
   【新增】StopAudioFile()
   - 功能：停止默認 alias 的音頻文件
   
   【新增】StopAudioFileWithAlias()
   - 功能：停止指定 alias 的音頻文件
   - 特性：狀態檢查、重試機制、資源清理
   
   【新增】FadeOutAudioFileWithAlias()
   - 功能：淡出音頻文件（已棄用，改為立即停止）

3. 修改的線程函數
   ────────────────────────────────────────────────────────────────────────
   【修改】SoundThreadProc()
   - 添加背景音樂播放邏輯
   - 添加引擎音效播放邏輯
   - 添加煞車音效處理
   - 添加碰撞、遊戲結束、勝利音效處理
   - 添加音效狀態監控和自動恢復
   - 添加資源管理和錯誤處理
   
   【修改】PhysicsThreadProc()
   - 添加碰撞音效觸發
   - 添加勝利音效觸發
   - 添加遊戲結束狀態檢測

   【修改】RenderThreadProc()
   - 添加速度感視覺效果
   - 添加 GAME OVER 畫面渲染
   - 添加 VICTORY 畫面渲染
   - 添加速度條顯示
   - 添加動畫效果

   【修改】main()
   - 添加控制台窗口大小鎖定
   - 添加窗口調整禁用
   - 啟動 Sound 線程

================================================================================
技術改進
================================================================================

1. 資源管理 (Resource Management)
   ────────────────────────────────────────────────────────────────────────
   【改進】音效資源管理
   - 播放前檢查設備狀態
   - 播放前關閉舊設備
   - 播放失敗時自動清理資源
   - 添加延遲確保資源釋放
   
   【改進】錯誤處理
   - MCI 錯誤檢測和處理
   - 文件格式自動檢測和降級
   - 播放狀態監控和自動恢復
   
   【改進】線程安全
   - 使用原子變量管理音效狀態
   - 使用互斥鎖保護共享資源
   - 避免競態條件

2. 音效播放邏輯優化
   ────────────────────────────────────────────────────────────────────────
   【改進】格式檢測
   - 根據文件擴展名智能選擇格式
   - MP3 失敗時自動嘗試 WAV
   - WAV 失敗時自動嘗試 MP3
   
   【改進】播放控制
   - 加速音效：按下時重新開始，鬆開時立即停止
   - 煞車音效：按下時播放，鬆開時立即停止
   - 背景音樂：進入地圖時開始，退出時停止
   - 引擎運轉聲：移動時持續播放，停止時關閉

3. 性能優化
   ────────────────────────────────────────────────────────────────────────
   【改進】資源釋放
   - 增加資源釋放延遲時間
   - 改進設備關閉邏輯
   - 避免資源洩漏
   
   【改進】狀態檢查
   - 減少不必要的 MCI 命令
   - 優化狀態檢查頻率
   - 改進錯誤恢復機制

================================================================================
文件結構變更
================================================================================

1. 新增文件
   ────────────────────────────────────────────────────────────────────────
   【新增】README.md
   - 完整的遊戲說明文檔
   - 包含安裝、設置、操作、故障排除等章節
   - 詳細的音效設置說明
   
   【新增】CHANGELOG.txt (本文件)
   - 記錄所有變更歷史
   
   【新增】audio/ 資料夾
   - 統一存放所有音效文件
   - 包含 README.txt 說明文件

2. 文件組織
   ────────────────────────────────────────────────────────────────────────
   【重組】音效文件
   - 從根目錄移動到 audio/ 資料夾
   - 統一管理，便於維護

================================================================================
詳細變更列表
================================================================================

【音效系統相關變更】

1. 添加 Windows Multimedia Library 支持
   - #include <mmsystem.h>
   - #pragma comment(lib, "winmm.lib")

2. 音效文件路徑管理
   - 添加 AUDIO_FOLDER 常量
   - 添加 GetAudioPath() 輔助函數
   - 所有音效文件路徑統一使用該函數

3. PlayAudioFile() 函數實現
   - 智能格式檢測（MP3/WAV）
   - 自動格式降級
   - 資源清理和錯誤處理
   - 循環播放支持

4. PlayAudioFileWithAlias() 函數實現
   - 支持自定義 alias
   - 設備狀態檢查
   - 資源清理
   - 多音效疊加支持

5. StopAudioFileWithAlias() 函數實現
   - 狀態檢查
   - 重試機制
   - 資源清理

【音效播放邏輯變更】

1. 背景音樂 (BGM)
   - 只在 KERNEL_RUNNING 狀態播放
   - 自動循環播放
   - 播放狀態監控和自動恢復
   - 遊戲結束時停止

2. 引擎運轉聲 (engine_idle)
   - 移動時（速度 > 0.1）持續播放
   - 自動循環
   - 音量保持 100%
   - 停止時關閉

3. 引擎加速聲 (engine_accel)
   - 按下加速鍵時播放
   - 與運轉聲疊加
   - 按下時重新開始（重置）
   - 鬆開時立即停止
   - 運行時狀態檢查和自動恢復

4. 煞車音效 (brake)
   - 按下左右鍵時播放
   - 鬆開時立即停止
   - 同步處理（不使用線程）

5. 碰撞音效 (crash)
   - 碰撞時觸發
   - 播放一次

6. 遊戲結束音效 (gameover)
   - 遊戲結束時播放
   - 停止背景音樂

7. 勝利音效 (victory)
   - 完成賽道時播放
   - 停止所有其他音效
   - 支持 MP3/WAV 自動切換

【視覺效果變更】

1. 速度感效果
   - 動態道路線條
   - 背景元素偏移（根據速度）
   - 速度條顯示
   - 高速指示器

2. GAME OVER 畫面
   - 顯示最終距離
   - 顯示遊戲時間
   - 顯示最終速度
   - 紅色主題

3. VICTORY 畫面
   - ASCII 藝術標題
   - 動畫效果
   - 顯示完成時間
   - 顯示平均速度
   - 性能評級系統
   - 彩虹/金色閃爍效果

【界面改進變更】

1. 窗口管理
   - SetConsoleScreenBufferSize: 設置緩衝區大小
   - SetConsoleWindowInfo: 設置窗口大小
   - SetWindowLongPtr: 禁用窗口調整
   - 鎖定窗口大小為 120x30

2. HUD 改進
   - 速度條顯示
   - 更清晰的狀態信息
   - 改進的距離顯示

【物理系統變更】

1. 碰撞檢測
   - 添加碰撞音效觸發
   - 改進碰撞檢測邏輯

2. 勝利條件
   - 添加勝利音效觸發
   - 改進勝利檢測邏輯

================================================================================
已知問題和解決方案
================================================================================

【已解決的問題】

1. 音效資源衝突
   - 問題：多個音效同時播放時發生衝突
   - 解決：使用不同的 MCI alias，改進資源管理

2. 音效無法停止
   - 問題：鬆開按鍵時音效無法停止
   - 解決：使用強制停止命令，同步處理

3. 長時間運行後音效失效
   - 問題：遊戲運行一段時間後加速音效失效
   - 解決：添加資源清理、狀態檢查、自動恢復機制

4. 勝利音效無法播放
   - 問題：勝利時音效無法播放
   - 解決：改為同步播放，添加格式自動切換

5. 全螢幕布局問題
   - 問題：全螢幕時界面布局混亂
   - 解決：鎖定窗口大小，禁用調整

6. BGM 不循環
   - 問題：背景音樂播放一次後停止
   - 解決：添加播放狀態監控和自動恢復

================================================================================
向後兼容性
================================================================================

【兼容性說明】

1. 音效文件格式
   - 支持 MP3 和 WAV 格式
   - 自動檢測和降級
   - 如果文件不存在，使用 Beep 備用音效

2. 文件位置
   - 音效文件必須放在 audio/ 資料夾
   - 如果資料夾不存在，遊戲會嘗試從根目錄讀取（會失敗）

3. 編譯要求
   - 需要 C++11 標準
   - 需要 Windows Multimedia Library (winmm.lib)
   - 需要 Windows API 支持

================================================================================
未來改進建議
================================================================================

1. 音效系統
   - 添加音量控制選項
   - 添加音效開關選項
   - 支持更多音頻格式（OGG、FLAC 等）

2. 視覺效果
   - 添加更多粒子效果
   - 改進動畫系統
   - 添加更多視覺反饋

3. 遊戲功能
   - 添加設置選單
   - 添加音效測試功能
   - 添加更多遊戲模式

================================================================================
總結
================================================================================

從原始版本到當前版本，主要添加了：

1. 完整的音效系統（7 種音效）
2. 多音效疊加播放功能
3. 智能資源管理系統
4. 視覺效果增強
5. 結束畫面系統
6. 全螢幕布局修復
7. 詳細的文檔說明

總代碼行數：約 1642 行（原始版本約 1200 行）
新增代碼：約 442 行
修改代碼：約 200 行

================================================================================
版本信息
================================================================================

當前版本：v2.0
最後更新：2025年12月22日
開發語言：C++11
平台：Windows
編譯器：MinGW / MSVC

================================================================================

